---
name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-on-${{ github.event_name }}-from-${{ github.ref_name }}
  cancel-in-progress: true

jobs:

  build-cpu-gcc11:
    runs-on: ubuntu-latest
    name: CPU (gcc 11)
    steps:
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test CPU schedulers
        uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:gcc11-ubuntu20.04
        with:
          cc: gcc-11
          checks: build test
          prebuild_command: |
            apt update && apt install -y --no-install-recommends git;

  build-cpu-clang12:
    runs-on: ubuntu-latest
    name: CPU (clang 12)
    steps:
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test CPU schedulers
        uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:clang12-ubuntu20.04
        with:
          cc: clang-12
          checks: build test
          cxxflags: "-stdlib=libc++"
          prebuild_command: |
            apt update && apt install -y --no-install-recommends git;

  build-gpu:
    name: GPU (${{ matrix.name }})
    strategy:
      matrix:
        include:
          - { name: "nvc++ 22.11", cuda: "11.8", cxx: "mpic++",  gpu: "v100", driver: "495", arch: "amd64", cxxflags: "",              }
          - { name: "clang 16",    cuda: "11.8", cxx: "clang++", gpu: "v100", driver: "495", arch: "amd64", cxxflags: "-stdlib=libc++" }
          - { name: "clang 16",    cuda: "12.0", cxx: "clang++", gpu: "v100", driver: "495", arch: "amd64", cxxflags: "-stdlib=libc++" }
    runs-on:
      - self-hosted
      - linux
      - gpu-${{ matrix.gpu }}-${{ matrix.driver }}-1
      - ${{ matrix.arch }}
    container:
      image: docker.io/pauletaylor/devcontainers:cmake-ninja-sccache-llvmdev-cuda${{ matrix.cuda }}-nvhpc22.11
      options: -u root -w /workspaces
      env:
        # CMAKE_CXX_COMPILER_LAUNCHER: /usr/bin/sccache
        # CMAKE_CUDA_COMPILER_LAUNCHER: /usr/bin/sccache
        NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }}
    steps:
      - name: Run nvidia-smi to make sure GPU is working
        run: nvidia-smi
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test GPU schedulers
        shell: bash
        run: |
          set -x;

          echo "HOME: $HOME";
          echo "cwd: $(pwd)";
          find . -type d -exec realpath -m {} \;

          cd ..;
          mv stdexec /workspaces/;
          cd /workspaces/stdexec/;

          echo "cwd: $(pwd)";
          find . -type d -exec realpath -m {} \;

          cmake -S . -B build \
            -GNinja \
            -DSTDEXEC_ENABLE_CUDA=ON \
            -DCMAKE_CUDA_ARCHITECTURES=native \
            -DCMAKE_CXX_FLAGS="${{ matrix.cxxflags }}" \
            -DCMAKE_CXX_COMPILER=$(which ${{ matrix.cxx }}) \
            -DCMAKE_CUDA_COMPILER=$(which ${{ matrix.cxx }});

          cmake --build build;

          ctest \
            --verbose \
            --test-dir build \
            --output-on-failure \
            --force-new-ctest-process;

#  build-clang-13:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:clang13
#        with:
#          cc: clang-13
#          checks: build test
#          cxxflags: -stdlib=libc++
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  static-checks:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          cc: clang-13
#          checks: cppcheck clang-tidy
#          clangtidyflags: '-quiet'
#          cppcheckflags: '--enable=warning,style,performance,portability --inline-suppr'
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  clang-format:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          checks: clang-format
#          clangformatdirs: src test
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  sanitizer:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          checks: sanitize=address sanitize=undefined
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;
