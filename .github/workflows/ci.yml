---
name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-on-${{ github.event_name }}-from-${{ github.ref_name }}
  cancel-in-progress: true

jobs:

  build-cpu-gcc11:
    runs-on: ubuntu-latest
    name: CPU (gcc 11)
    steps:
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test CPU schedulers
        uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:gcc11-ubuntu20.04
        with:
          cc: gcc-11
          checks: build test
          prebuild_command: |
            apt update && apt install -y --no-install-recommends git;

  build-cpu-clang12:
    runs-on: ubuntu-latest
    name: CPU (clang 12)
    steps:
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test CPU schedulers
        uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:clang12-ubuntu20.04
        with:
          cc: clang-12
          checks: build test
          cxxflags: "-stdlib=libc++"
          prebuild_command: |
            apt update && apt install -y --no-install-recommends git;

  build-gpu:
    name: GPU (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - { name: "clang 16, CUDA 11.8",    cxx: "clang++", tag: "llvmdev-cuda11.8", gpu: "v100", driver: "520", arch: "amd64", cxxflags: "-stdlib=libc++ -Wno-unknown-cuda-version" }
        # - { name: "clang 16, CUDA 12.0",    cxx: "clang++", tag: "llvmdev-cuda12.0", gpu: "v100", driver: "520", arch: "amd64", cxxflags: "-stdlib=libc++ -Wno-unknown-cuda-version" }
          - { name: "nvc++ 22.11, CUDA 11.8", cxx: "mpic++",  tag: "nvhpc22.11",       gpu: "v100", driver: "520", arch: "amd64", cxxflags: "",                                        }

    runs-on:
      - self-hosted
      - linux
      - gpu-${{ matrix.gpu }}-${{ matrix.driver }}-1
      - ${{ matrix.arch }}
    container:
      image: docker.io/pauletaylor/devcontainers:cmake-ninja-sccache-${{ matrix.tag }}
      # image: ghcr.io/trxcllnt/devcontainer-images:cmake-ninja-sccache-${{ matrix.tag }}-${{ matrix.arch }}
      options: -u coder
      env:
        # CMAKE_CXX_COMPILER_LAUNCHER: /usr/bin/sccache
        # CMAKE_CUDA_COMPILER_LAUNCHER: /usr/bin/sccache
        CUDA_VERSION: "11.8"
        NVIDIA_DRIVER_CAPABILITIES: all
        NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }}
    steps:
      - name: Run nvidia-smi to make sure GPU is working
        run: nvidia-smi
      - name: Checkout stdexec
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Build and test GPU schedulers
        shell: bash
        run: |
          source $BASH_ENV;

          sudo ldconfig -p | grep libcuda.so;
          sudo find / -type f -name 'libcuda.so*';

          sudo mkdir -p /workspaces/stdexec/;
          sudo cp -ar . /workspaces/stdexec/;
          sudo chown -R $(id -u):$(id -g) /workspaces;

          cmake \
            -S /workspaces/stdexec \
            -B /workspaces/stdexec/build \
            -GNinja \
            -DSTDEXEC_ENABLE_CUDA=ON \
            -DCMAKE_CUDA_ARCHITECTURES=native \
            -DCMAKE_CXX_FLAGS="${{ matrix.cxxflags }}" \
            -DCMAKE_CXX_COMPILER=$(which ${{ matrix.cxx }}) \
            -DCMAKE_CUDA_COMPILER=$(which ${{ matrix.cxx }}) \
            || configure_failed=1 \
          ;

          if [[ "${configure_failed:-}" == "1" ]]; then
            tar --exclude-vcs -czf /github/home/build.tgz -C /workspaces/stdexec .;
            exit 1;
          fi;

          cmake --build /workspaces/stdexec/build;

          ctest \
            --verbose \
            --output-on-failure \
            --force-new-ctest-process \
            --test-dir /workspaces/stdexec/build \
            ;

      - name: Upload build context on failure
        if: failure()
        uses: actions/upload-artifact@v3
        env:
          ACTIONS_STEP_DEBUG: "true"
        with:
          name: build-${{ matrix.tag }}.tgz
          path: /github/home/build.tgz

#  build-clang-13:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:clang13
#        with:
#          cc: clang-13
#          checks: build test
#          cxxflags: -stdlib=libc++
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  static-checks:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          cc: clang-13
#          checks: cppcheck clang-tidy
#          clangtidyflags: '-quiet'
#          cppcheckflags: '--enable=warning,style,performance,portability --inline-suppr'
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  clang-format:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          checks: clang-format
#          clangformatdirs: src test
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;

#  sanitizer:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@master
#      - uses: docker://ghcr.io/trxcllnt/action-cxx-toolkit:main
#        with:
#          checks: sanitize=address sanitize=undefined
#          prebuild_command: |
#            apt update && apt install -y --no-install-recommends git;
